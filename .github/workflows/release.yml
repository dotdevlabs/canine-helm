name: Release Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
  release:
    types:
      - created
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      # -------------------------------------------------------------
      # Fetch previous gh-pages/index.yaml safely
      # -------------------------------------------------------------
      - name: Fetch existing index.yaml from gh-pages
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || echo "gh-pages does not exist yet"

          # Try retrieving previous index.yaml into index.old.yaml
          if git show origin/gh-pages:index.yaml > index.old.yaml 2>/dev/null; then
            if [ -s index.old.yaml ]; then
              echo "Found existing non-empty index.yaml"
            else
              echo "index.yaml exists but is empty â€” removing"
              rm -f index.old.yaml
            fi
          else
            echo "No previous index.yaml found"
          fi

      # -------------------------------------------------------------
      # Install Helm
      # -------------------------------------------------------------
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      # -------------------------------------------------------------
      # Update dependencies (if any)
      # -------------------------------------------------------------
      - name: Run helm dependency update
        run: helm dependency update

      # -------------------------------------------------------------
      # Package chart
      # -------------------------------------------------------------
      - name: Package chart
        run: helm package .

      # -------------------------------------------------------------
      # Create or merge Helm repo index
      # -------------------------------------------------------------
      - name: Create Helm repository index
        run: |
          URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

          if [ -s index.old.yaml ]; then
            echo "Merging with previous index.yaml"
            helm repo index . --url "$URL" --merge index.old.yaml
          else
            echo "Creating new index.yaml"
            helm repo index . --url "$URL"
          fi

      # -------------------------------------------------------------
      # Publish to GitHub Pages
      # -------------------------------------------------------------
      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          keep_files: false
          destination_dir: .
          allow_empty_commit: true